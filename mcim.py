from colormath.color_diff_matrix import delta_e_cie1976 as delta_e
from colormath.color_objects import LabColor, sRGBColor
from colormath.color_conversions import convert_color

from PIL import Image
from numpy import array, argmin
from argparse import ArgumentParser
from tqdm import tqdm   # progress bar

# Load block to LAB dictionary
block_color_palette = {"acacia_log": [4299.930867262001, 80.90786997067312, 581.4090686493344], "acacia_planks": [4824.01565153545, 2494.0052208468587, 3167.2917598061267], "andesite": [5644.14515613865, -0.02241561276861148, -0.41775087122033483], "barrel": [3905.261146619437, 610.604172742125, 1937.0267043534866], "bedrock": [3871.01165412813, -0.01539355363888717, -0.28688354453265674], "birch_log": [8143.554618872918, -46.861372769264165, 219.50187950071438], "birch_log[axis=z]": [7050.417663951888, -142.4787007806252, 2078.1895733202264], "birch_planks": [6932.937496881954, -139.04872732443607, 2556.9282156718104], "black_concrete": [695.332356906455, 97.12950642669904, -403.8059121098069], "black_concrete_powder": [1501.9561896342782, 88.33833300546789, -330.77962101134233], "black_glazed_terracotta": [2202.8921447355683, 1582.2675826107381, 684.5613820121678], "black_terracotta": [1491.1487286042131, 640.2580510936549, 701.7740020016554], "black_wool": [1262.0471588644189, 65.46223023634124, -279.27073237059864], "blast_furnace": [4656.416277838041, -0.018503955477200407, -0.3448508681202611], "blast_furnace[facing=east]": [4656.416277838041, -0.018503955477200407, -0.3448508681202611], "blue_concrete": [2983.062559061382, 2862.8738894549224, -4568.245259852188], "blue_concrete_powder": [3857.375636450952, 2394.737024430789, -4332.702886815392], "blue_glazed_terracotta": [3348.2236414216873, 1753.0604954911003, -3756.399291227832], "blue_ice": [6653.040694345001, 676.1335887936468, -4072.2517216019583], "blue_terracotta": [3140.441978603245, 1210.9096318608117, -1447.2969148248048], "blue_wool": [3363.74778320664, 2787.116819665574, -4677.8463202609855], "bone_block": [8439.134805408807, -144.30335649874593, 790.8375656877411], "bookshelf": [4330.42903680732, 409.54098677536524, 2032.2916028211218], "bricks": [4781.747982547729, 1722.4946481802128, 1473.2092524074487], "brown_concrete": [3242.488396380436, 1208.528081638976, 2079.959436033903], "brown_concrete_powder": [4176.442269970095, 1198.1525306692654, 2160.6019512678927], "brown_glazed_terracotta": [4679.986214757058, 144.38444429512742, 1181.3800981752095], "brown_mushroom_block": [5068.489620367844, 975.5834835924304, 1947.2026373299357], "brown_terracotta": [2815.3075527604547, 872.983082733965, 1319.311040192339], "brown_wool": [3745.619858113087, 1354.2056240986894, 2262.3853584117555], "carved_pumpkin": [4460.334351852368, 2039.2676140276294, 3836.7967546872956], "chiseled_quartz_block": [8495.752608062052, 26.449006152844845, 383.122821358549], "chiseled_red_sandstone": [5115.335689201826, 2691.6081423622877, 4291.158392909538], "chiseled_sandstone": [7758.7476337761755, -187.60427925023748, 2156.514351440326], "chiseled_stone_bricks": [5046.491303546092, 49.99063659732883, -36.05933599565958], "clay": [6614.194399100061, 44.185321169916136, -634.8308170593143], "coal_block": [968.1228422986284, 49.832150068375825, 17.884321085858446], "coal_ore": [4968.103454454688, -0.019738315884865187, -0.3678551526363094], "coarse_dirt": [4139.513308712143, 954.841161726499, 1800.0340539412498], "cobblestone": [5342.575721170658, -0.021221321190978415, -0.3954933335222677], "composter": [3691.122857912706, 1284.7588956965, 2601.3789797663235], "cracked_stone_bricks": [5012.23957631025, 50.07581815416273, -36.116949545470334], "crafting_table": [4721.88593122635, 416.4043358281404, 2005.0623939387422], "cut_red_sandstone": [5283.402991540496, 2684.343908890071, 4351.533252185687], "cut_sandstone": [7859.846274060915, -287.33678144966035, 2115.7530628148907], "cyan_concrete": [4741.281729844211, -1565.2028864284482, -1399.8672189990912], "cyan_concrete_powder": [5591.810570276731, -2111.6263934373374, -1155.5934646089781], "cyan_glazed_terracotta": [4728.30903803221, -1535.3317505273196, -851.6575378117437], "cyan_terracotta": [4051.6456715094755, -170.11806521717077, -59.1631462224683], "cyan_wool": [5269.826261311003, -2101.381780043049, -1049.8675816532314], "dark_oak_log": [2466.5184450487354, 333.1574375941244, 1346.9925829782273], "dark_oak_log[axis=z]": [2406.6627822734376, 720.3323709429163, 1556.5230825411131], "dark_oak_planks": [2457.681304218835, 747.998825971294, 1666.780206049916], "dark_prismarine": [3816.0931112679164, -1562.5569089044084, 436.1836153680571], "dead_brain_coral_block": [5047.932094031862, 182.4705423773949, 224.97503090304178], "dead_bubble_coral_block": [5257.535433709312, 198.01174447343328, 281.7054611694118], "dead_fire_coral_block": [5257.535433709312, 198.01174447343328, 281.7054611694118], "dead_horn_coral_block": [5351.203290412774, 163.5732452297951, 268.2326136329607], "dead_tube_coral_block": [5249.828558873335, 164.5175028424859, 269.5976827738775], "diamond_block": [8198.923535562815, -3299.661583639825, -565.8388593429692], "diamond_ore": [5728.940089018345, -539.568937023617, -131.4440866389205], "diorite": [7317.0369197362015, -0.0290406891458872, -0.5412197880815484], "dirt": [4560.437061503013, 1040.0574305035484, 1960.388481476255], "dispenser": [5146.436480671038, 32.519207641200865, 11.116435612939313], "dried_kelp_block": [2323.439666536339, -748.9577610601152, 957.7540616774207], "dropper": [5146.436480671038, 32.519207641200865, 11.116435612939313], "emerald_block": [7003.130499662945, -5266.440252622225, 3934.740328544736], "emerald_ore": [5491.412644079451, -803.7593195918867, 356.71254339237066], "end_stone": [8226.160629918859, -928.1425927867062, 2652.8366641391867], "end_stone_bricks": [8269.988033908401, -1002.2923043599974, 2535.821141824037], "fletching_table": [6318.725201273773, 16.60955770365291, 2184.7464420378883], "furnace": [4088.8661708988147, -0.016256312871831824, -0.30296244563174923], "furnace[facing=south]": [5105.063550254074, -0.020280712654141553, -0.3779635858592201], "glowstone": [5727.427876392179, 843.74460563253, 2678.6073484212807], "gold_block": [8031.545777481011, -20.045246897240077, 6105.913301963124], "gold_ore": [5765.106312868278, -138.42143331395462, 721.7511294873689], "granite": [4900.232698351759, 1408.4738163802372, 1527.5440515286973], "gravel": [5369.35487962721, 112.83410654128545, 92.2820754861533], "gray_concrete": [2795.7768249300357, -25.11337323516294, -256.71142397195865], "gray_concrete_powder": [3694.470055940091, -113.44440677058998, -212.81701005380782], "gray_glazed_terracotta": [4009.403949270561, -177.56951845927205, -231.22661389671606], "gray_terracotta": [2337.881841701935, 526.1025046374002, 654.639888952213], "gray_wool": [3198.2496084928775, -150.50243531962872, -231.6039889101802], "green_concrete": [3869.841466124185, -1402.778685532102, 2463.7086595164824], "green_concrete_powder": [4806.509205164174, -1701.918130132814, 3180.0728292654794], "green_glazed_terracotta": [5557.216574846185, -1812.422028312369, 3123.1937997317787], "green_terracotta": [3668.0199446020256, -848.0700899971349, 1977.9751652790821], "green_wool": [4443.298562900668, -1837.0059124230984, 3346.819966771348], "hay_block": [5758.075039403159, 182.48517602371095, 4454.063300282937], "honeycomb_block": [6631.806130679892, 1982.7236643053893, 5592.546553623647], "iron_block": [8299.358090604563, -0.03293093053713392, -0.613720671651663], "iron_ore": [5480.396973794863, 145.2391766851342, 208.13938401370962], "jack_o_lantern": [6565.388809661053, 1297.062883407243, 4942.840127576882], "jigsaw": [2762.822871186522, 543.3039965208088, -416.59453529136243], "jigsaw[facing=north]": [3405.260143231156, 626.1714930068151, -472.8002833554129], "jukebox": [3127.51452574483, 987.1109237809499, 1459.85706700693], "jungle_log": [3299.640507395478, 270.9303571037402, 2356.166830954795], "jungle_log[axis=z]": [5009.59077991466, 986.3320756732321, 2404.895883813748], "jungle_planks": [5265.700259601113, 1180.3929695616516, 2269.368956590088], "lapis_block": [3369.3161823571936, 1444.2363191590123, -3777.76930926019], "lapis_ore": [4748.281042801479, 103.99547120596253, -1161.046813905422], "light_blue_concrete": [5476.600174645736, -409.71994625276056, -3339.6701533797723], "light_blue_concrete_powder": [6688.926159641815, -1640.79708938376, -2161.225494685182], "light_blue_glazed_terracotta": [6328.5306600482945, -756.9266061260258, -2476.9988117181824], "light_blue_terracotta": [4813.499493896551, 719.5638289736088, -1309.3865590848268], "light_blue_wool": [6546.4172064807035, -1472.3973717181095, -2571.275336592109], "light_gray_concrete": [5251.806916721324, -164.83057694356873, 468.6748888279638], "light_gray_concrete_powder": [6221.968424974676, -96.92382831982016, 268.9799902718349], "light_gray_glazed_terracotta": [6485.845845523668, -633.0147382869384, -264.4565914772201], "light_gray_terracotta": [4847.367347352681, 879.8586227477152, 820.7828348037822], "light_gray_wool": [5824.602314161382, -130.1636318051287, 364.9988244444856], "lime_concrete": [6123.4029860151795, -3753.744984265975, 4852.511763323078], "lime_concrete_powder": [6808.564295374763, -3535.7283714790883, 5198.805575134258], "lime_glazed_terracotta": [7199.418959551977, -2583.1743220154626, 5293.0435239197805], "lime_terracotta": [4796.946943119692, -1331.0784024881136, 2866.5537524530287], "lime_wool": [6646.609330182318, -3821.0414455012833, 5297.041679979915], "loom": [5217.892361665283, 600.8890507076608, 2088.2598788527007], "loom[facing=south]": [4794.755001219189, 1247.4343781537805, 2032.5245705815405], "magenta_concrete": [4541.33113337528, 5057.925567532145, -2817.2590734584373], "magenta_concrete_powder": [5354.545298474545, 4776.72952440573, -2778.02465435996], "magenta_glazed_terracotta": [5817.009898775855, 4597.838496250034, -2386.7477604047167], "magenta_terracotta": [4643.729646693687, 2390.110798309465, -22.909465254591055], "magenta_wool": [5111.740141132983, 5151.733342567369, -2913.083091097255], "magma_block": [3976.20022444852, 2734.6650885469367, 3017.213113105701], "melon": [5623.417646237476, -2287.8017068206163, 4373.898544142423], "mossy_cobblestone": [4927.7410770185825, -655.196624060558, 1054.067025942014], "mossy_stone_bricks": [5060.213611662478, -463.14069862325266, 689.7361437346306], "mushroom_stem": [7589.08296239904, 45.45015623655502, 544.5865678842197], "netherrack": [2862.5996151378426, 2309.3038616248978, 1273.0661277311021], "nether_bricks": [1609.5733198704743, 1111.5277918672648, 200.6881114325104], "nether_quartz_ore": [3690.935487478296, 1927.3879011996407, 1053.2526028811135], "nether_wart_block": [2918.440482895898, 3392.1256873560724, 2845.398429707652], "note_block": [3127.51452574483, 987.1109237809499, 1459.85706700693], "oak_log": [4022.486780091095, 482.10842858967237, 2082.24007420227], "oak_log[axis=z]": [5303.017288269407, 493.6510093377216, 2624.9327237666193], "oak_planks": [5614.503416821041, 510.9527769261497, 2795.865925328566], "observer": [4516.222450154049, -0.017948752304874915, -0.33450376711101626], "observer[facing=east]": [3252.4613600079683, 73.27664250532351, 25.83853328066681], "observer[facing=south]": [3290.5811309113437, 73.05783556148882, 25.7541956650428], "observer[facing=up]": [4339.437227060685, -0.01724863790997233, -0.32145601322213224], "obsidian": [850.3266830469939, 673.1177566203819, -855.2830471249216], "orange_concrete": [5685.345447356166, 3983.32728088419, 5190.440565716255], "orange_concrete_powder": [6289.727589863913, 2675.8295526603283, 5301.932343053268], "orange_glazed_terracotta": [5958.327333161932, -486.9431355281613, 2613.2117142856673], "orange_terracotta": [4595.271162470704, 2523.3538757849524, 3442.25182108506], "orange_wool": [6224.474415270172, 3657.377965002528, 5516.843396618425], "packed_ice": [7048.158669247451, 434.1065706457066, -3305.3497569852525], "pink_concrete": [5744.779043284755, 4102.727360131968, -61.1152418140577], "pink_concrete_powder": [6902.988759675195, 2727.3019601246206, -240.95618215061876], "pink_glazed_terracotta": [6990.547774822632, 2892.081733962911, -104.41413291996184], "pink_terracotta": [4553.8401105305575, 2947.5162695529634, 1453.0356438862257], "pink_wool": [6756.1910177480695, 3422.4745311530073, -16.51548263534721], "polished_andesite": [5560.989059846977, -80.61553439781122, 23.424350254479975], "polished_diorite": [7468.273445603679, -13.741394836479515, -53.777455333531066], "polished_granite": [5023.93346756442, 1479.3508260778801, 1500.3393712249747], "prismarine": [5975.298653990746, -1678.160762171128, -272.61362954714343], "prismarine_bricks": [6377.976486222819, -2176.0677115089456, -18.260732276280578], "pumpkin": [5595.221458642447, 2299.3061578891875, 4763.0026248678005], "purple_concrete": [3414.6484303607454, 4344.940303387766, -4526.420435792086], "purple_concrete_powder": [4194.891084216576, 4467.630756455222, -4320.824591033319], "purple_glazed_terracotta": [3678.8074654842503, 3868.2814084986853, -3881.434929649309], "purple_terracotta": [3858.3469651293776, 1973.7605152959184, -33.99695332400654], "purple_wool": [3896.1591842298794, 4631.576632324972, -4556.907374959504], "purpur_block": [5762.121289873121, 2109.974085562957, -1426.3208759607878], "purpur_pillar": [5868.043048702132, 2008.1707865812816, -1361.7979601212396], "quartz_block": [8594.403905234374, 69.98599635765856, 350.87873192415486], "quartz_pillar": [8619.86896975537, 55.15805698601639, 298.77283969833286], "redstone_block": [4156.488634318662, 4667.993704032277, 4015.651444859553], "redstone_ore": [4873.110738397259, 891.1490427675872, 340.7377804339774], "red_concrete": [3598.328577949292, 3770.7342812413654, 2629.751812580908], "red_concrete_powder": [4281.353550853457, 3922.24324321322, 2587.4288648385295], "red_glazed_terracotta": [4553.6440632786735, 4134.686834335618, 2798.2404245964694], "red_mushroom_block": [4743.7454325736, 4939.755533238237, 3468.4299554938475], "red_nether_bricks": [1958.6949519193442, 2249.692747391821, 1748.7669064423787], "red_sand": [5314.814880153771, 2678.063166271052, 4327.818858266808], "red_sandstone": [5208.403182451793, 2665.550784897505, 4328.792686085585], "red_terracotta": [3971.9399435977853, 2902.540578904329, 2332.8804376335056], "red_wool": [3982.0671060809395, 4077.7929625107417, 3007.594331128331], "sand": [7902.110341102919, -221.40459915000577, 1996.932168507982], "sandstone": [7780.707100193677, -231.83624268366287, 2186.127685562826], "sea_lantern": [7473.835680405251, -925.5678381732189, 123.848994498168], "smithing_table": [2202.831000617005, 823.0918365472703, 279.84050862763115], "smoker": [3565.4902250288083, 182.29134174489303, 1098.403748178481], "smoker[facing=east]": [4143.103380981665, 148.06811454830537, 941.8441097583873], "smooth_stone": [6365.20291480149, -0.02527118467554601, -0.47096903057450845], "smooth_stone_slab[type=double]": [6654.272041040319, -0.02641597185260025, -0.492303974466779], "snow_block": [9281.300956894986, -139.58822594304365, -49.53915158117752], "soul_sand": [3159.4875047799433, 570.2813854727307, 930.8888533335321], "sponge": [7297.610387567334, -1124.1468710706429, 4888.461105517742], "spruce_log": [2193.67667959199, 713.997314438382, 1557.3420523520206], "spruce_log[axis=z]": [3887.3168506422026, 675.3247610349433, 2115.4273851862363], "spruce_planks": [4048.678020542606, 724.6538580795452, 2222.752131270134], "stone": [5274.988432569175, -0.02095365835685925, -0.39050500761987905], "stone_bricks": [5148.901807167338, 49.7401838811804, -35.89003830822719], "stripped_acacia_log": [4946.258190304911, 2650.023024644728, 2918.7981913243275], "stripped_acacia_log[axis=z]": [4817.43459872921, 2381.192967018588, 3108.90155853216], "stripped_birch_log": [6982.041391376565, -73.19660935500139, 2760.7413127966965], "stripped_birch_log[axis=z]": [6828.770423088319, -39.090734074960665, 2645.892832830978], "stripped_dark_oak_log": [3667.206371913956, 415.2101640483696, 1670.7594562688464], "stripped_dark_oak_log[axis=z]": [2471.413652889982, 654.6755158682363, 1578.7980021778712], "stripped_jungle_log": [5749.39678375366, 795.7288449809994, 2705.5648082311977], "stripped_jungle_log[axis=z]": [5469.04504922702, 1032.9595930479948, 2486.3964934329033], "stripped_oak_log": [6072.186649564565, 461.21965138275914, 3020.1436214626683], "stripped_oak_log[axis=z]": [5572.511211800361, 476.39648002658674, 2786.3290979879694], "stripped_spruce_log": [4182.154154990547, 532.9324741214236, 2189.442447530223], "stripped_spruce_log[axis=z]": [3855.3453640081866, 551.4543780788337, 2070.0341249912035], "terracotta": [4719.8726047618775, 1816.7258824445796, 2202.7509300237534], "wet_sponge": [6872.882953752482, -1536.9508584273176, 4537.043083412792], "white_concrete": [8051.049717225399, -157.33433148774623, -103.03753988666244], "white_concrete_powder": [8497.58689781764, -57.24178124672363, -20.72752622629821], "white_glazed_terracotta": [7888.579539271934, -847.0734586499162, 189.9558565214761], "white_terracotta": [7195.742408763115, 735.2321909712458, 1098.7341453953547], "white_wool": [8760.732730775382, -85.11946475586996, -30.50232592803752], "yellow_concrete": [7279.296495634845, 1156.9787026443023, 6195.819316573808], "yellow_concrete_powder": [7723.202266785383, -153.15520204315902, 5965.9864245454355], "yellow_glazed_terracotta": [7607.146196555608, 353.3640536433751, 4809.05459105413], "yellow_terracotta": [5881.922590502894, 1092.4052426118892, 4709.403122405885], "yellow_wool": [7809.0050939174, 488.676797068031, 6391.931783988401]}

def pil2mcfunction(image, progress_bar=False):
    """Returns the Minecraft representation of an image as a *.mcfunction.
       Output is executable within a data-pack in-game. """
    
    assert image.mode == "P", "error: mode of image isn't 'P', but instead '%s'" % image.mode
    
    # Load image's palette (to be compared w/ block_color_palette)
    image_palette = array(image.getpalette()).reshape(256, 3)
    
    # Find closest color in color_palette for each color in image_palette
    blocks, colors = zip(*block_color_palette.items())
    
    # Find the closest color to 'color' in 'colors' by using delta e cie1976
    colors = array(colors)
    impal2colpal = [argmin(delta_e(
                        array(convert_color(sRGBColor(*rgb), LabColor).get_value_tuple()),
                        colors))
                    for rgb in image_palette]
    
    del colors, image_palette
    
    # Generate *.mcfunction file by using the palette
    pixel_indices = list(image.getdata())
    return 'gamerule maxCommandChainLength %d\n' % (len(pixel_indices) + 2) + \
           ''.join('setblock ~%d ~%d ~ %s\n' % (-(i % image.width), image.height - i // image.width - 1, blocks[impal2colpal[pixel_indices[i]]])
                   for i in ( tqdm(range(len(pixel_indices))) if progress_bar else range(len(pixel_indices))) ) + 'gamerule maxCommandChainLength 65536'
    
# Driver
if __name__ == "__main__":
    
    # Argument parsing
    parser = ArgumentParser()
    parser.add_argument('fp', metavar='file-path', help='the file path of the image')
    parser.add_argument('-d', '--dest', metavar='file-path', default='result.mcfunction', help='what to save the file as')
    parser.add_argument('-s', '--scale', metavar='N', default=1.0, type=float, help='a decimal to appropriately scale an image')
    parser.add_argument('-p', '--progress-bar', action='store_true', help='displays a progress bar')
    parser.add_argument('-q', '--suppress', action='store_true', help="won't query users about large images")
    
    args = parser.parse_args()
    
    # Convert to an indexed image (w/ palette)
    im = Image.open(args.fp).convert("P")
    im = im.resize((int(im.width * args.scale), int(im.height * args.scale)))
    
    # For large images, ask them if they'd like to continue
    if not args.suppress and im.width * im.height >= 300_000:
        if input("This image is big (%d >= 300000); it may take long to complete, do you still want to proceed? (y/N) " % (im.width * im.height)) != 'y':
            print("Aborted.")
            quit()

        args.progress_bar = True

    # Write the file
    with open(args.dest, 'w') as f:
        f.write(pil2mcfunction(im, args.progress_bar))
